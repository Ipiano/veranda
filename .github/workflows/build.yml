name: Build

on:
  push:

jobs:
  build-ubuntu-jazzy-qt515:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup ROS 2 Jazzy
      uses: ros-tooling/setup-ros@v0.7
      with:
        required-ros-distributions: jazzy

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-colcon-common-extensions \
          python3-rosdep \
          qtbase5-dev \
          qtdeclarative5-dev \
          libqt5svg5-dev

    - name: Initialize rosdep
      run: |
        sudo rosdep init || true
        rosdep update

    - name: Install ROS dependencies
      run: |
        cd veranda
        rosdep install --from-paths Packages --ignore-src -r -y

    - name: Build workspace
      run: |
        cd veranda
        source /opt/ros/jazzy/setup.bash
        colcon build --symlink-install --cmake-args -DCMAKE_FIND_DEBUG_MODE=ON

    - name: Run tests
      run: |
        cd veranda
        source /opt/ros/jazzy/setup.bash
        source install/setup.bash
        colcon test --event-handlers console_direct+

    - name: Test results
      run: |
        cd veranda
        colcon test-result --verbose

  build-windows-jazzy:
    name: build-windows-jazzy-${{ matrix.qt-short }}
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - qt-version: '5.12.12'
            qt-arch: 'win64_msvc2017_64'
            qt-short: 'qt512'
            build-testing: 'ON'
          - qt-version: '5.15.2'
            qt-arch: 'win64_msvc2019_64'
            qt-short: 'qt515'
            build-testing: 'ON'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Setup Python 3.9 explicitly before ROS setup to ensure consistency.
    # The setup-ros action installs catkin_pkg in Python 3.9, but CMake's
    # find_package(Python3) may find a different Python version (e.g., 3.12)
    # on the runner. We need both setup-ros and CMake to use the same Python.
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Setup MSVC Developer Command Prompt
      uses: ilammy/msvc-dev-cmd@v1

    - name: Setup ROS 2 Jazzy
      uses: ros-tooling/setup-ros@v0.7
      with:
        required-ros-distributions: jazzy

    - name: Fix colcon-meson compatibility
      shell: cmd
      run: |
        pip uninstall -y colcon-meson || exit 0

    - name: Update colcon packages
      shell: cmd
      run: |
        REM Update all colcon packages to resolve deprecation warnings
        REM See: https://github.com/colcon/colcon-core/issues/554
        pip install -U colcon-common-extensions colcon-core

    - name: Setup Qt
      uses: jurplel/install-qt-action@v4
      with:
        # ROS 2 Jazzy officially targets Qt 5.12.12 on Windows, but 5.15.2 also works
        version: ${{ matrix.qt-version }}
        arch: ${{ matrix.qt-arch }}

    - name: Install dependencies
      run: |
        choco install -y wget

    - name: Build workspace
      shell: cmd
      run: |
        call C:\dev\jazzy\ros2-windows\local_setup.bat
        cd veranda
        REM Force CMake to use Python 3.9 by explicitly passing Python3_EXECUTABLE.
        REM Without this, CMake may find Python 3.12 which lacks the catkin_pkg module.
        REM Disable desktop notifications to avoid Windows message handling errors in CI
        colcon build --symlink-install --event-handlers console_direct+ desktop_notification- --cmake-args -DCMAKE_BUILD_TYPE=Release -DPython3_EXECUTABLE=C:\hostedtoolcache\windows\Python\3.9.13\x64\python.exe -DBUILD_TESTING=${{ matrix.build-testing }}

    - name: Run tests
      if: matrix.build-testing == 'ON'
      shell: cmd
      run: |
        call C:\dev\jazzy\ros2-windows\local_setup.bat
        cd veranda
        call install\local_setup.bat
        colcon test --event-handlers console_direct+ desktop_notification-
      continue-on-error: true

    - name: Test results
      if: matrix.build-testing == 'ON'
      run: |
        cd veranda
        colcon test-result --verbose
      continue-on-error: true
